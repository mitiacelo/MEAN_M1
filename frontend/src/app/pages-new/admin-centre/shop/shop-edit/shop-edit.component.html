<div class="shop-edit">

  @if (loading) {
    <p>Chargement...</p>
  } @else if (error) {
    <p>{{ error }}</p>
  } @else {

    <div class="edit-header">
      <button (click)="retourDashboard()">‚Üê Dashboard</button>
      <h2>{{ shop.name }} ‚Äî Admin</h2>
      <span class="shop-status" [class]="'status-' + shop.status">{{ shop.status }}</span>
    </div>

    <!-- ‚îÄ‚îÄ Infos g√©n√©rales ‚îÄ‚îÄ -->
    <div class="edit-section">
      <h3>Informations</h3>
      <label>Nom</label>
      <input [(ngModel)]="editNom" type="text" />
      <label>Description</label>
      <textarea [(ngModel)]="editDescription" rows="3"></textarea>
      <label>Superficie (m¬≤)</label>
      <input [(ngModel)]="editSuperficie" type="number" />
      <button (click)="sauvegarderInfos()">Sauvegarder</button>
    </div>

    <!-- ‚îÄ‚îÄ Locataire ‚îÄ‚îÄ -->
    <div class="edit-section">
      <h3>Locataire</h3>

      @if (shop.id_user) {
        <p class="user-actuel">Assign√© √† : <strong>{{ getUserNom() }}</strong></p>
        @if (!contract || contract.statut === 'brouillon') {
          <button class="btn-danger" (click)="desassignerUser()">Retirer le locataire</button>
        }
      } @else {
        <p class="user-actuel">Aucun locataire assign√©</p>
        <select [(ngModel)]="editUserId">
          <option value="">-- Choisir un locataire --</option>
          @for (user of users; track user._id) {
            <option [value]="user._id">
              {{ user.firstname }} {{ user.name }} ‚Äî {{ user.email }}
            </option>
          }
        </select>
        <button (click)="assignerUser()" [disabled]="!editUserId">Assigner</button>
      }
    </div>

    <!-- ‚îÄ‚îÄ Contrat de bail ‚îÄ‚îÄ -->
    <div class="edit-section">
      <h3>Contrat de bail</h3>

      @if (!shop.id_user && !editUserId) {
        <p class="info-msg">‚ö†Ô∏è Assignez d'abord un locataire pour cr√©er un contrat.</p>

      } @else if (!contract) {
        <p class="user-actuel">Aucun contrat cr√©√© pour cette boutique.</p>
        <button (click)="ouvrirFormulaireContrat()">+ Cr√©er un contrat</button>

      } @else {
        <!-- R√©sum√© contrat existant -->
        <div class="contrat-resume">
          <div class="contrat-statut" [class]="'statut-' + contract.statut">
            {{ statutContratLabel(contract.statut) }}
          </div>
          <div class="contrat-infos">
            <span>Loyer : <strong>{{ contract.loyer }} Ar</strong></span>
            <span>Charges : <strong>{{ contract.charges }} Ar</strong></span>
            <span>D√©but : <strong>{{ contract.dateDebut | date:'dd/MM/yyyy' }}</strong></span>
            <span>Fin : <strong>{{ contract.dateFin | date:'dd/MM/yyyy' }}</strong></span>
          </div>
        </div>

        <div class="contrat-actions">
          <!-- Voir PDF toujours disponible -->
          <button class="btn-secondary" (click)="voirPDF()">üìÑ Voir le PDF</button>

          <!-- Modifier uniquement si brouillon -->
          @if (contract.statut === 'brouillon') {
            <button (click)="ouvrirFormulaireContrat()">‚úèÔ∏è Modifier</button>
            <button class="btn-accent" (click)="signerContratAdmin()" [disabled]="signingAdmin">
              {{ signingAdmin ? 'Envoi...' : '‚úçÔ∏è Signer & Envoyer au client' }}
            </button>
          }

          <!-- R√©silier si actif -->
          @if (contract.statut === 'actif') {
            <button class="btn-danger" (click)="resilierContrat()" [disabled]="resiliating">
              {{ resiliating ? 'En cours...' : 'üî¥ R√©silier le contrat' }}
            </button>
          }
        </div>
      }

      <!-- Formulaire contrat -->
      @if (showContratForm) {
        <div class="contrat-form">
          <h4>{{ contract ? 'Modifier le contrat' : 'Nouveau contrat' }}</h4>

          <div class="form-grid">
            <div class="form-group">
              <label>Loyer mensuel (Ar)</label>
              <input type="number" [(ngModel)]="contratForm.loyer" />
            </div>
            <div class="form-group">
              <label>Charges mensuelles (Ar)</label>
              <input type="number" [(ngModel)]="contratForm.charges" />
            </div>
            <div class="form-group">
              <label>D√©p√¥t de garantie (Ar)</label>
              <input type="number" [(ngModel)]="contratForm.depot" />
            </div>
            <div class="form-group">
              <label>Dur√©e du contrat</label>
              <input type="text" [(ngModel)]="contratForm.dureeContrat" placeholder="ex: 12 mois" />
            </div>
            <div class="form-group">
              <label>Date de d√©but</label>
              <input type="date" [(ngModel)]="contratForm.dateDebut" />
            </div>
            <div class="form-group">
              <label>Date de fin</label>
              <input type="date" [(ngModel)]="contratForm.dateFin" />
            </div>
          </div>

          <div class="form-group full">
            <label>Clauses particuli√®res</label>
            <textarea [(ngModel)]="contratForm.clauses" rows="5"
              placeholder="Ajoutez ici toutes clauses sp√©cifiques au contrat..."></textarea>
          </div>

          <div class="form-actions">
            <button class="btn-accent" (click)="sauvegarderContrat()" [disabled]="savingContrat">
              {{ savingContrat ? 'Sauvegarde...' : 'üíæ Sauvegarder le contrat' }}
            </button>
            <button class="btn-secondary" (click)="showContratForm = false">Annuler</button>
          </div>
        </div>
      }
    </div>

  }
</div>