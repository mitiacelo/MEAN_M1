<div class="dashboard">

  <!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
  <div class="dash-header">
    <div>
      <h2>Dashboard</h2>
      <p class="dash-subtitle">Vue d'ensemble du centre commercial</p>
    </div>
    <button class="btn-primary" (click)="allerGrille()">G√©rer le centre ‚Üí</button>
  </div>

  <div class="loading-state" *ngIf="loading">Chargement‚Ä¶</div>

  <ng-container *ngIf="!loading">

    <!-- ‚ïê‚ïê KPIs ‚ïê‚ïê -->
    <div class="kpi-row">

      <div class="kpi-card kpi-card--green" (click)="allerGrille()">
        <div class="kpi-top"><span class="kpi-icon">üè¨</span><span class="kpi-label">Locaux</span></div>
        <div class="kpi-value">{{ totalLocaux }}</div>
        <div class="kpi-sub">
          <span class="sub-green">{{ locauxOccupes }} occup√©s</span>
          <span class="sub-sep">¬∑</span>
          <span class="sub-muted">{{ locauxVacants }} vacants</span>
        </div>
        <div class="kpi-bar-row">
          <div class="kpi-bar"><div class="kpi-fill kpi-fill--green" [style.width.%]="tauxOccupation"></div></div>
          <span class="kpi-pct">{{ tauxOccupation }}%</span>
        </div>
      </div>

      <div class="kpi-card kpi-card--blue" (click)="allerLocation()">
        <div class="kpi-top"><span class="kpi-icon">üí∞</span><span class="kpi-label">Loyers ce mois</span></div>
        <div class="kpi-value">{{ formatMontant(encaisseMonth) }}</div>
        <div class="kpi-sub"><span class="sub-muted">sur {{ formatMontant(attenduMonth) }}</span></div>
        <div class="kpi-bar-row">
          <div class="kpi-bar"><div class="kpi-fill kpi-fill--blue" [style.width.%]="tauxEncaissement"></div></div>
          <span class="kpi-pct">{{ tauxEncaissement }}%</span>
        </div>
        <div class="kpi-alert kpi-alert--orange" *ngIf="loyersImpayes > 0">
          ‚ö† {{ loyersImpayes }} impay√©{{ loyersImpayes > 1 ? 's' : '' }}
        </div>
      </div>

      <div class="kpi-card kpi-card--orange" (click)="allerMaintenance()">
        <div class="kpi-top"><span class="kpi-icon">üîß</span><span class="kpi-label">Maintenance</span></div>
        <div class="kpi-value">{{ maintenanceOuverts }}</div>
        <div class="kpi-sub"><span class="sub-muted">tickets ouverts</span></div>
        <div class="kpi-alert kpi-alert--red" *ngIf="maintenanceUrgents > 0">
          üî¥ {{ maintenanceUrgents }} urgent{{ maintenanceUrgents > 1 ? 's' : '' }}
        </div>
        <div class="kpi-ok" *ngIf="maintenanceUrgents === 0 && maintenanceOuverts === 0">‚úì Tout est en ordre</div>
      </div>

      <div class="kpi-card kpi-card--purple" (click)="allerNotifications()">
        <div class="kpi-top"><span class="kpi-icon">üîî</span><span class="kpi-label">Notifications</span></div>
        <div class="kpi-value">{{ notifNouveaux }}</div>
        <div class="kpi-sub"><span class="sub-muted">non lues</span></div>
        <div class="kpi-ok" *ngIf="notifNouveaux === 0">‚úì √Ä jour</div>
      </div>

    </div>

    <!-- ‚ïê‚ïê GRAPHIQUES ‚ïê‚ïê -->
    <div class="charts-row">

      <!-- Graphique 1 : Encaissements 6 mois -->
      <div class="chart-card chart-card--wide">
        <div class="chart-header">
          <div>
            <h3>Encaissements ‚Äî 6 derniers mois</h3>
            <p class="chart-sub">Loyers encaiss√©s (barres) et impay√©s (courbe)</p>
          </div>
          <button class="btn-link" (click)="allerLocation()">G√©rer ‚Üí</button>
        </div>
        <div class="chart-wrap">
          <canvas #chartEncaissement></canvas>
        </div>
      </div>

      <!-- Graphique 2 : Occupation -->
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <h3>Occupation</h3>
            <p class="chart-sub">R√©partition des {{ totalLocaux }} locaux</p>
          </div>
        </div>
        <div class="chart-wrap chart-wrap--donut">
          <canvas #chartOccupation></canvas>
        </div>
        <div class="donut-center">
          <span class="donut-pct">{{ tauxOccupation }}%</span>
          <span class="donut-label">occup√©</span>
        </div>
      </div>

    </div>

    <!-- ‚ïê‚ïê GRAPHIQUE INCIDENTS + ACTIVIT√â ‚ïê‚ïê -->
    <div class="bottom-row">

      <!-- Graphique 3 : Incidents par cat√©gorie -->
      <div class="chart-card" *ngIf="maintenanceParCategorie.length > 0">
        <div class="chart-header">
          <div>
            <h3>Incidents par cat√©gorie</h3>
            <p class="chart-sub">Tickets ouverts</p>
          </div>
          <button class="btn-link" (click)="allerMaintenance()">Voir ‚Üí</button>
        </div>
        <div class="chart-wrap chart-wrap--incidents">
          <canvas #chartIncidents></canvas>
        </div>
      </div>
      <div class="chart-card chart-placeholder" *ngIf="maintenanceParCategorie.length === 0">
        <div class="placeholder-content">
          <span class="placeholder-icon">‚úì</span>
          <p>Aucun incident en cours</p>
        </div>
      </div>

      <!-- Loyers √† traiter -->
      <div class="section-card">
        <div class="section-header">
          <h3>Loyers √† traiter</h3>
          <button class="btn-link" (click)="allerLocation()">Voir tout ‚Üí</button>
        </div>
        <div class="activity-ok" *ngIf="loyersRecents.length === 0">‚úì Tous les loyers sont √† jour</div>
        <div class="loyer-row" *ngFor="let entry of loyersRecents">
          <div class="loyer-left">
            <div class="loyer-dot" [class]="'ldot-' + entry.loyerMois.statut"></div>
            <div>
              <div class="loyer-shop">{{ entry.contract.shop.name }}</div>
              <div class="loyer-tenant">{{ entry.contract.user.firstname }} {{ entry.contract.user.name }}</div>
            </div>
          </div>
          <div class="loyer-right">
            <div class="loyer-amount">{{ entry.loyerMois.montant | number }} Ar</div>
            <span class="loyer-badge" [class]="'lbadge-' + entry.loyerMois.statut">
              {{ statutLoyerLabel(entry.loyerMois.statut) }}
            </span>
          </div>
        </div>
      </div>

      <!-- Tickets urgents -->
      <div class="section-card">
        <div class="section-header">
          <h3>Incidents urgents</h3>
          <button class="btn-link" (click)="allerMaintenance()">Voir tout ‚Üí</button>
        </div>
        <div class="activity-ok" *ngIf="ticketsUrgents.length === 0">‚úì Aucun incident urgent</div>
        <div class="ticket-row" *ngFor="let t of ticketsUrgents">
          <div class="ticket-icon">{{ categorieIcon(t.categorie) }}</div>
          <div class="ticket-info">
            <div class="ticket-titre">{{ t.titre }}</div>
            <div class="ticket-shop">{{ t.shop.name }}</div>
          </div>
          <span class="ticket-st" [class]="'ts-' + t.statut">{{ t.statut }}</span>
        </div>
      </div>

    </div>

    <!-- ‚ïê‚ïê GRILLE APER√áU + LISTE SHOPS ‚ïê‚ïê -->
    <div class="grille-row">

      <div class="section-card section-card--grille">
        <div class="section-header">
          <h3>Plan du centre</h3>
          <button class="btn-link" (click)="allerGrille()">G√©rer la grille ‚Üí</button>
        </div>
        <div class="grille-wrap">
          <table class="grille-table"
            [style.--colonnes]="colonnes"
            [style.--lignes]="lignes">
            <thead>
              <tr>
                <th></th>
                <th *ngFor="let num of getNumeros()">{{ num }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let lettre of getLettres()">
                <td class="lettre-col">{{ lettre }}</td>
                <td *ngFor="let num of getNumeros()"
                  class="block-cell"
                  [class.assigned]="isAssigned(lettre, num)"
                  [style.background-color]="getBlockColor(lettre, num)">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="shops-legend">
          <div class="legend-item" *ngFor="let shop of shops.slice(0, 10)">
            <span class="legend-dot" [style.background]="getShopColor(shop._id)"></span>
            <span class="legend-name">{{ shop.name }}</span>
            <span class="legend-st" [class]="'lst-' + shop.status">{{ shop.status }}</span>
          </div>
          <div class="legend-more" *ngIf="shops.length > 10">+{{ shops.length - 10 }} autres</div>
        </div>
      </div>

    </div>

  </ng-container>
</div>