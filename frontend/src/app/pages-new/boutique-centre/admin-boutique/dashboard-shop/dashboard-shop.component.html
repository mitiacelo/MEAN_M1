<div class="dashboard-shop-container">
  <header class="dashboard-header">
    <h1>Tableau de bord - Mes salles et boutiques</h1>
    <p>Bienvenue, {{ authService.currentUser?.firstname }} !</p>

    <div class="actions">
      <button class="btn logout" (click)="logout()">D√©connexion</button>
      <button class="btn back" routerLink="/landing">Retour √† l'accueil</button>
    </div>
  </header>

  @if (loading) {
    <p class="loading">Chargement en cours...</p>
  } @else if (errorMessage) {
    <p class="error">{{ errorMessage }}</p>
  } @else {
    @if (shops.length === 0) {
      <p class="info">Vous n'avez pas encore de salle attribu√©e.</p>
    } @else {
      <!-- STATISTIQUES GLOBALES ‚Äì TOUJOURS AFFICH√âES -->
      <div class="stats-section">
        <h2>Vue d'ensemble ‚Äì Toutes mes boutiques</h2>

        <!-- KPI Cards -->
        <div class="kpi-row">
          <div class="kpi-card kpi-green">
            <div class="kpi-icon">üí∞</div>
            <div class="kpi-label">CA aujourd'hui</div>
            <div class="kpi-value">{{ caToday | number:'1.0-0' }} Ar</div>
            <div class="kpi-sub" [ngClass]="{'positive': caTodayChange > 0, 'negative': caTodayChange < 0}">
              {{ caTodayChange > 0 ? '+' : '' }}{{ caTodayChange | number:'1.0-0' }}% vs hier
            </div>
          </div>

          <div class="kpi-card kpi-orange" [class.alert]="lowStockCount > 0">
            <div class="kpi-icon">‚ö†Ô∏è</div>
            <div class="kpi-label">Stock faible</div>
            <div class="kpi-value">{{ lowStockCount }}</div>
            <div class="kpi-sub">produits ‚â§ 5 unit√©s</div>
          </div>

          <div class="kpi-card kpi-blue">
            <div class="kpi-icon">üì¶</div>
            <div class="kpi-label">Commandes en attente</div>
            <div class="kpi-value">{{ pendingOrders }}</div>
            <div class="kpi-sub">√† pr√©parer / livrer</div>
          </div>

          <div class="kpi-card kpi-purple">
            <div class="kpi-icon">üë•</div>
            <div class="kpi-label">Nouveaux clients</div>
            <div class="kpi-value">{{ newClients30d }}</div>
            <div class="kpi-sub">sur 30 jours</div>
          </div>
        </div>

        <!-- ALERTES STOCK CRITIQUE + AUTRES -->
        @if (alerts.length > 0) {
          <div class="alerts-section">
            <h3>Alertes importantes</h3>
            <div class="alert-list">
              @for (alert of alerts; track $index) {
                <div class="alert alert-warning">
                  <span class="alert-icon">‚ö†Ô∏è</span>
                  <span>{{ alert }}</span>
                </div>
              }
            </div>
          </div>
        }

        <!-- Top 5 produits vendus -->
        <div class="top-products">
          <h3>Top 5 produits vendus (7 jours) ‚Äì Toutes boutiques</h3>
          <div class="top-list">
            @for (item of topProducts; track item.product._id) {
              <div class="top-item">
                <span class="rank">{{ $index + 1 }}</span>
                <span class="name">{{ item.product.name }}</span>
                <span class="quantity">{{ item.quantity }} vendus</span>
              </div>
            }
            @if (topProducts.length === 0) {
              <p class="empty">Aucune vente r√©cente</p>
            }
          </div>
        </div>

        <!-- Derni√®res commandes -->
        <div class="recent-orders">
          <h3>Derni√®res commandes ‚Äì Toutes boutiques</h3>
          <table class="orders-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Montant</th>
                <th>Statut</th>
              </tr>
            </thead>
            <tbody>
              @for (order of recentOrders; track order._id) {
                <tr>
                  <td>{{ order.createdAt | date:'short' }}</td>
                  <td>{{ order.totalPrice | number:'1.0-0' }} Ar</td>
                  <td [ngClass]="'status-' + order.status">{{ order.status }}</td>
                </tr>
              }
              @if (recentOrders.length === 0) {
                <tr><td colspan="3" class="empty">Aucune commande r√©cente</td></tr>
              }
            </tbody>
          </table>
        </div>
      </div>
      <!-- Liste des salles (inchang√©e) -->
      <div class="shops-list">
        <h2>Vos salles</h2>
        @for (shop of shops; track shop._id) {
          <div class="shop-card" [class.active]="selectedShop?._id === shop._id">
            <h3>{{ shop.name }}</h3>
            <p>Superficie : {{ shop.superficie }} m¬≤</p>
            <p>Statut : {{ shop.status }}</p>

            @let boutique = boutiquesMap[shop._id];
            @if (boutique) {
              <div class="boutique-info">
                <h4>Boutique : {{ boutique.name }}</h4>
                <p>Domaine : {{ boutique.id_domaine?.name || 'Non d√©fini' }}</p>
                <p>{{ boutique.description || 'Aucune description' }}</p>

                <button class="btn primary" (click)="selectShop(shop)">
                  G√©rer les produits
                </button>
                <button class="btn secondary" (click)="startEditBoutique()">
                  Modifier boutique
                </button>
              </div>
            } @else if (shop.status === 'actif') {
              <button class="btn create" (click)="showCreateBoutique = true; selectedShop = shop">
                Cr√©er une boutique dans cette salle
              </button>
            } @else {
              <p class="info">Salle non active ‚Äì impossible de cr√©er une boutique pour l'instant.</p>
            }
          </div>
        }
      </div>

      <!-- Formulaire cr√©ation boutique -->
      @if (showCreateBoutique && selectedShop) {
        <div class="create-form">
          <h3>Cr√©er une boutique dans {{ selectedShop.name }}</h3>
          <form (ngSubmit)="createBoutique()">
            <div class="form-group">
              <label>Nom :</label>
              <input [(ngModel)]="newBoutique.name" required />
            </div>
            <div class="form-group">
              <label>Description :</label>
              <textarea [(ngModel)]="newBoutique.description"></textarea>
            </div>
            <div class="form-group">
              <label>Domaine :</label>
              <select [(ngModel)]="newBoutique.id_domaine" required>
                <option value="" disabled>S√©lectionner</option>
                @for (dom of domaines; track dom._id) {
                  <option [value]="dom._id">{{ dom.name }}</option>
                }
              </select>
            </div>
            <div class="form-buttons">
              <button type="submit" [disabled]="!newBoutique.name || !newBoutique.id_domaine">
                Cr√©er
              </button>
              <button type="button" (click)="showCreateBoutique = false">Annuler</button>
            </div>
          </form>
        </div>
      }

      <!-- √âdition boutique -->
      @if (isEditingBoutique && selectedBoutique) {
        <div class="edit-form">
          <h3>Modifier la boutique</h3>
          <div class="form-group">
            <label>Nom :</label>
            <input [(ngModel)]="editedBoutique.name" required />
          </div>
          <div class="form-group">
            <label>Description :</label>
            <textarea [(ngModel)]="editedBoutique.description"></textarea>
          </div>
          <div class="form-group">
            <label>Domaine :</label>
            <select [(ngModel)]="editedBoutique.id_domaine" required>
              <option value="" disabled>S√©lectionner</option>
              @for (dom of domaines; track dom._id) {
                <option [value]="dom._id">{{ dom.name }}</option>
              }
            </select>
          </div>
          <div class="form-buttons">
            <button class="save-btn" (click)="saveBoutiqueEdit()" [disabled]="!editedBoutique.name || !editedBoutique.id_domaine">
              Enregistrer
            </button>
            <button class="cancel-btn" (click)="cancelEditBoutique()">Annuler</button>
          </div>
        </div>
      }

      <!-- Produits de la boutique s√©lectionn√©e (conditionnel) -->
      @if (selectedBoutique) {
        <div class="products-section">
          <h2>Produits de {{ selectedBoutique.name }}</h2>
        
          <div class="actions">
            <button class="btn primary" (click)="showCreateProductForm = !showCreateProductForm">
              {{ showCreateProductForm ? 'Fermer le formulaire' : 'Ajouter un produit' }}
            </button>
        
            <button class="btn secondary" (click)="fileInput.click()" [disabled]="importLoading">
              {{ importLoading ? 'Import en cours...' : 'Importer depuis CSV / Excel' }}
            </button>
        
            <input
              type="file"
              #fileInput
              accept=".csv,.xlsx"
              (change)="onFileSelected($event)"
              style="display: none;"
            />
          </div>
        
          @if (importError) {
            <div class="error-message">{{ importError }}</div>
          }
          @if (importSuccess) {
            <div class="success-message">{{ importSuccess }}</div>
          }
        
          @if (showCreateProductForm) {
            <app-create-product
              [boutiqueId]="selectedBoutique!._id"
              (productCreated)="onProductCreated($event)"
              (cancel)="showCreateProductForm = false">
            </app-create-product>
          }
        
          <app-product-list
            [products]="products"
            [types]="types"
            (productUpdated)="onProductUpdated($event)"
            (productDeleted)="onProductDeleted($event)">
          </app-product-list>
        </div>
      } @else if (shops.length > 0) {
        <p class="info">S√©lectionnez une salle pour g√©rer ses produits.</p>
      }
    }
  }
</div>